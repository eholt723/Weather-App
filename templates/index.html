<!DOCTYPE html>
<html>
<head>
  <title>Weather App-Eric Holt</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='glow_round_favicon.png') }}?v=1">
  <link rel="shortcut icon" href="{{ url_for('static', filename='glow_round_favicon.png') }}?v=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f2f6fc; }
    .weather-card { max-width: 1100px; margin: 30px auto; }
    .chart-container { position: relative; height:350px; width:100%; }
    .error { color: #c00; font-weight: bold; }
    @media (max-width: 767px) { .chart-container { height:250px; } }
  </style>
</head>
<body>
  <div class="container weather-card p-4 bg-white rounded shadow">
    <h2 class="mb-4">Weather Look-Up App</h2>
    <form method="post" class="mb-3">
      <div class="input-group">
        <input type="text" name="location" id="location" class="form-control" placeholder="City or ZIP" value="{{ location|default('') }}" required autofocus>
        <button class="btn btn-primary" type="submit">Fetch Weather</button>
      </div>
    </form>

    {% if weather %}
    <div class="row">
      <div class="col-md-6 col-12 mb-4">
        <h4>Current Weather in {{ weather['city'] }}</h4>
        <ul class="list-group mb-3">
          <li class="list-group-item">Temperature: {{ weather['temp_f'] }}°F</li>
          <li class="list-group-item">Description: {{ weather['description'] }}</li>
          <li class="list-group-item">Humidity: {{ weather['humidity'] }}%</li>
          <li class="list-group-item">Wind Speed: {{ weather['wind'] }} m/s</li>
        </ul>

        <h4>5-Day Forecast</h4>
        <div class="table-responsive">
          <table class="table table-bordered align-middle text-center">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Min (°F)</th>
                <th>Max (°F)</th>
                <th>Description</th>
                <th>Icon</th>
              </tr>
            </thead>
            <tbody>
              {% for day in forecast %}
              <tr>
                <td>{{ day['date'] }}</td>
                <td>{{ day['min_temp_f'] }}</td>
                <td>{{ day['max_temp_f'] }}</td>
                <td>{{ day['desc'] }}</td>
                <td><img src="https://openweathermap.org/img/wn/{{ day['icon'] }}.png" alt="icon"></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="col-md-6 col-12 d-flex align-items-center justify-content-center">
        <div class="chart-container w-100">
          <canvas id="tempChart"></canvas>
        </div>
      </div>
    </div>

    {% elif error %}
      <div class="error">{{ error }}</div>
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  {% if forecast %}
  <!-- Embed the forecast arrays as JSON so the JS stays valid (and VS Code stops throwing errors). -->
  <script id="forecast-labels" type="application/json">
    {{ forecast|map(attribute='date')|list|tojson }}
  </script>
  <script id="forecast-mins" type="application/json">
    {{ forecast|map(attribute='min_temp_f')|list|tojson }}
  </script>
  <script id="forecast-maxs" type="application/json">
    {{ forecast|map(attribute='max_temp_f')|list|tojson }}
  </script>
  {% endif %}

  <script>
    document.getElementById("location")?.focus();

    const labelsEl = document.getElementById("forecast-labels");
    const minsEl = document.getElementById("forecast-mins");
    const maxsEl = document.getElementById("forecast-maxs");

    // Only render the chart if forecast JSON exists.
    if (labelsEl && minsEl && maxsEl) {
      const labels = JSON.parse(labelsEl.textContent || "[]");
      const mins = JSON.parse(minsEl.textContent || "[]");
      const maxs = JSON.parse(maxsEl.textContent || "[]");

      if (labels.length) {
        const canvas = document.getElementById("tempChart");
        const ctx = canvas?.getContext("2d");

        if (ctx) {
          new Chart(ctx, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Min Temp (°F)",
                  data: mins,
                  borderColor: "#3498db",
                  backgroundColor: "rgba(52,152,219,0.2)",
                  tension: 0.2
                },
                {
                  label: "Max Temp (°F)",
                  data: maxs,
                  borderColor: "#e67e22",
                  backgroundColor: "rgba(230,126,34,0.2)",
                  tension: 0.2
                }
              ]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: "top" },
                title: { display: true, text: "5-Day Temperature Trend" }
              }
            }
          });
        }
      }
    }
  </script>
</body>
</html>
